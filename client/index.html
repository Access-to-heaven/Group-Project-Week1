<!doctype html>
<html lang="en">
<head>
  <title>Access to HEAVEN</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <!-- OAuth Google -->
  <meta name="google-signin-client_id" content="527048370228-1gio572fe3g3jcufr4kdre2if78djp70.apps.googleusercontent.com">
  
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
  <!-- Font-awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.min.css">
  
</head>
<body>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="#">Access to HEAVEN</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active" id="nav-home">
          <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item" id="nav-login">
          <a class="nav-link" href="#" onclick="navLogin()">Login</a>
        </li>
        <li class="nav-item" id="nav-jadwal-sholat">
          <a class="nav-link" href="#">Jadwal Sholat</a>
        </li>
        <li class="nav-item" id="nav-alquran">
          <a class="nav-link" href="#">Alquran</a>
        </li>
        <li class="nav-item" id="nav-kisah-nabi">
          <a class="nav-link" href="#">Kisah Nabi</a>
        </li>
        <li class="nav-item" id="nav-logout">
          <a class="nav-link" href="#">Logout</a>
        </li>
      </ul>
    </div>
  </nav>
  
  <div class="container-fluid mt-5">
    <div class="row pr-4 pl-4" id="row-login">
      <div class="card mt-5 pl-0 pr-0 col-md-4 mx-auto">
        <div class="card-header">
          Login
        </div>
        <div class="card-body">
          <form id="login-form">
            <div class="form-group">
              <label for="inputLoginEmail">Email address</label>
              <input type="email" class="form-control form-control rounded-pill" id="inputLoginEmail" placeholder="email@example.com" required>
            </div>
            <div class="form-group">
              <label for="inputLoginPassword">Password</label>
              <input type="password" class="form-control form-control rounded-pill" id="inputLoginPassword" placeholder="Password" required>
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary rounded-pill col">Login</button>
              <hr>
            </div>
            <div class="text-center">
              <div class="g-signin2" data-onsuccess="onSignIn">Login GOOGLE</div>
            </div>
            <div id="errorLogin"></div>
            <div class="text-center mt-2">
              <a href="#" onclick="anchorRegister()">Create an Account!</a>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="row pr-4 pl-4" id="row-register">
      <div class="card mt-5 pl-0 pr-0 col-md-4 mx-auto">
        <div class="card-header">
          Create an Account
        </div>
        <div class="card-body">
          <form id="register-form">
            <div class="form-group">
              <label for="inputRegisterName">Name</label>
              <input type="text" class="form-control rounded-pill" id="inputRegisterName" placeholder="Name">
            </div>
            <div class="form-group">
              <label for="inputRegisterEmail">Email address</label>
              <input type="email" class="form-control rounded-pill" id="inputRegisterEmail" placeholder="email@example.com" required>
            </div>
            <div class="form-group">
              <label for="inputRegisterCity">City</label>
              <input type="text" class="form-control rounded-pill" id="inputRegisterCity" placeholder="City">
            </div>
            <div class="form-group">
              <label for="inputRegisterPassword">Password</label>
              <input type="password" class="form-control rounded-pill" id="inputRegisterPassword" placeholder="Password" required>
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary rounded-pill col" onclick="register()">Register Account</button>
              <hr>
            </div>
            <div class="text-center mt-2"> 
              <a href="#"  onclick="anchorLogin()">Already have an account? Login!</a>
            </div>
          </form>
          <br>
          <div id="errorRegister"></div>
        </div>
      </div>
    </div>
    
    <div class="row pr-4 pl-4" id="row-jadwal-sholat">
      <!-- get jadwal sholat from database -->
      <div class="card mt-5 pl-0 pr-0 col-md-8 mx-auto">
        <div class="card-header" id="title-jadwal-sholat">
          Jadwal Sholat Hari ini
        </div>
        <div class="card-body">
          <table class="table table-bordered display table-striped" id="datatable-jadwal-sholat" style="width:100%">
            <thead class="thead-dark">
              <tr>
                <th>#</th>
                <th>Kota</th>
                <th>Subuh</th>
                <th>Dzuhur</th>
                <th>Ashr</th>
                <th>Magrib</th>
                <th>Isya</th>
              </tr>
            </thead>
            <tbody id="tbody-jadwal-sholat">
              
              
            </tbody>
          </table>
        </div>
      </div>
        
    </div>

    <div class="row pr-4 pl-4" id="row-weather">
      <!-- get jadwal sholat from database -->
      
        
    </div>
    
    <div class="row pr-4 pl-4" id="row-al-quran">
      <!-- get al-quran sholat from database -->
      <div class="card mt-5 pl-0 pr-0 col-md-8 mx-auto">
        <div class="card-header">
          Alquran
        </div>
        <div class="card-body">
          <table class="table table-bordered display table-striped table-dark" id="datatable-alquran" style="width:100%">
            <thead class="thead-dark">
              <tr>
                <th>#</th>
                <th>Nama</th>
                <th>Asma</th>
                <th>Ayat</th>
                <th>Arti</th>
                <th>Urut</th>
                <th>Audio</th>
              </tr>
            </thead>
            <tbody id="tbody-alquran">
              
              
            </tbody>
          </table>
        </div>
      </div>
      
    </div>

    <div class="row pr-4 pl-4" id="row-kisah-nabi">
      <!-- get kisah-nabi sholat from database -->
      <div class="mt-5 pl-0 pr-0 col-md-8 mx-auto">
        <form action="#" id="form-nabi">
          <div class="form-group">
            <label for="input-nabi"></label>
            <input type="text"
              class="form-control" id="input-nabi" placeholder="nabi">
          </div>
          <button type="submit" class="btn btn-info" onclick="getKisahNabi()">Submit</button>
        </form>    
      </div>
      <div class="mt-3 card pl-0 pr-0 col-md-8 mx-auto">
        <div class="card-header">
          Kisah Nabi
        </div>
        <div class="card-body">
          <!-- <table class="table table-bordered display table-striped" id="datatable-kisah-nabi" style="width:100%">
            <thead class="thead-dark">
              <tr>
                <th>#</th>
                <th>Nama</th>
                <th>lahir</th>
                <th>umur</th>
                <th>Tempat</th>
                <th>Image</th>
                <th>Kisah</th>
              </tr>
            </thead>
            <tbody id="tbody-kisah-nabi">
              
              
            </tbody>
          </table> -->
          <div class="text-center" id="body-kisah-nabi"></div>
        </div>
      </div>
      
    </div>
  </div>
  <!-- OAuth Google -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <script src="http://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
  <!-- sweetalert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.14.0/dist/sweetalert2.all.min.js"></script>
  
  <!-- dataTables -->
  <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.6/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.2.6/js/responsive.bootstrap4.min.js"></script>
  <script>
    
    const base_url = "http://localhost:3000/"
    
    $(document).ready(() => {
      // let oTable = $('#product-table').DataTable();
      auth()
      $("#login-form").on("submit", (e) => {
        e.preventDefault()
        login()
      })
      
      $("#register-form").on("submit", (e) => {
        e.preventDefault()
        register()
      })
      
      $("#nav-logout").on("click", (e) => {
        e.preventDefault()
        logout()
      })

      $("#nav-home").on("click", (e) => {
        e.preventDefault()
        $("#row-al-quran").hide()
        $("#row-kisah-nabi").hide()
        $("#row-jadwal-sholat").show()
        $("#row-weather").show()
        getJadwalSholat()
        getWeather()
      })

      $("#nav-jadwal-sholat").on("click", (e) => {
        e.preventDefault()
        $("#row-al-quran").hide()
        $("#row-kisah-nabi").hide()
        $("#row-jadwal-sholat").show()
        $("#row-weather").hide()
        getJadwalSholatMonthly()
      })
      
      $("#nav-alquran").on("click", (e) => {
        e.preventDefault()
        $("#row-jadwal-sholat").hide()
        $("#row-jadwal-sholat").hide()
        $("#row-kisah-nabi").hide()
        $("#row-al-quran").show()
        $("#row-weather").hide()

        getAlQuran()
      })

      $("#nav-kisah-nabi").on("click", (e) => {
        e.preventDefault()
        $("#row-al-quran").hide()
        $("#row-jadwal-sholat").hide()
        $("#row-jadwal-sholat").hide()
        $("#row-kisah-nabi").show()
        $("#row-weather").hide()

        getKisahNabi()
      })

      $("#form-nabi").on("submit", (e) => {
        e.preventDefault()
        $("#row-al-quran").hide()
        $("#row-jadwal-sholat").hide()
        $("#row-jadwal-sholat").hide()
        $("#row-kisah-nabi").show()
        $("#row-weather").hide()

        getKisahNabi()
      });
      
    })
    
    function auth() {
      if (!localStorage.getItem("token")) {
        
        $("#row-login").show()
        $("#nav-logout").hide()
        $("#row-register").hide()
        $("#row-jadwal-sholat").hide()
        $("#row-kisah-nabi").hide()
        $("#row-al-quran").hide()
        $("#row-weather").hide()
        
        $("#nav-logout").hide()
        $("#nav-kisah-nabi").hide()
        $("#nav-alquran").hide()
        $("#nav-jadwal-sholat").hide()
        $("#nav-home").hide()
        
      } else {
        $("#nav-login").hide()
        $("#row-login").hide()
        $("#row-register").hide()
        $("#row-kisah-nabi").hide()
        $("#row-al-quran").hide()
        
        $("#nav-logout").show()
        $("#nav-kisah-nabi").show()
        $("#nav-alquran").show()
        $("#nav-jadwal-sholat").show()
        $("#nav-home").show()
        getJadwalSholat()
        getWeather()
      }
    }

    function onSignIn(googleUser) {
      const id_token = googleUser.getAuthResponse().id_token
      $.ajax({
        url: base_url + "login-google",
        method: 'POST',
        data: {
          googleToken: id_token
        }
      })
        .done(response => {
          localStorage.setItem("token", response.access_token)
          auth()
        })
        .fail((jqXHR, text) => {
          console.log(jqXHR.responseJSON)
          swalFail(xhr.responseJSON.error)
        })
    }
    
    function login() { // login-form
      const email = $("#inputLoginEmail").val()
      const password = $("#inputLoginPassword").val()
      $.ajax({
        url: base_url + "login",
        method: "POST",
        data: {
          email,
          password
        }
      })
      .done((response) => {
        localStorage.setItem("token", response.access_token)
        auth()
      })
      .fail((xhr, text) => {
        console.log(xhr, text)
        // $('#errorLogin').empty().append(`
        // <div class="alert alert-danger alert-dismissible fade show">
        //   <button type="button" class="close" data-dismiss="alert">&times;</button>
        //   <strong>Error!</strong> ${xhr.responseJSON.error}
        // </div>
        // `)
        swalFail(xhr.responseJSON.error)
      })
      .always(() => {
        $("#login-form").trigger("reset")
      })
    }
    
    function register() {
      const name = $("#inputRegisterName").val()
      const email = $("#inputRegisterEmail").val()
      const city = $("#inputRegisterCity").val()
      const password = $("#inputRegisterPassword").val()
      $.ajax({
        url: base_url + "register",
        method: "POST",
        data: {
          name,
          email,
          city,
          password
        }
      })
      .done((response) => {
        auth()
      })
      .fail((xhr, text) => {
        console.log(xhr, text)
        swalFail(xhr.responseJSON.error)
      })
      .always(() => {
        $("#register-form").trigger("reset")
      })
    }
    
    function logout() { // nav-logout
      localStorage.clear()
      let auth2 = gapi.auth2.getAuthInstance();
      auth2.signOut().then(() => {
        console.log('User signed out.')
      })
      auth()
    }
    
    function getJadwalSholat() { 
      $.ajax({
        url: base_url + "jadwal-sholat",
        method: "GET",
        headers: {
          token: localStorage.getItem("token")
        }
      })
      .done((dataJadwalSholat) => {
        $("#title-jadwal-sholat").empty().append(`
          Jadwal Sholat Hari ini
        `)
        $("#row-jadwal-sholat").show()
        $("#tbody-jadwal-sholat").empty()
        $("#tbody-jadwal-sholat").append(`
          <tr>
            <td>1</td>
            <td>${dataJadwalSholat.results.location.city}</td>
            <td>${dataJadwalSholat.results.datetime[0].times.Fajr}</td>
            <td>${dataJadwalSholat.results.datetime[0].times.Dhuhr}</td>
            <td>${dataJadwalSholat.results.datetime[0].times.Asr}</td>
            <td>${dataJadwalSholat.results.datetime[0].times.Maghrib}</td>
            <td>${dataJadwalSholat.results.datetime[0].times.Isha}</td>
          </tr>
        `);
      })
      .fail((xhr, text) => {
        console.log(xhr,text);
        swalFail(xhr.responseJSON.error)
      })
      
    }

    function getJadwalSholatMonthly() { 
      $.ajax({
        url: base_url + "jadwal-sholat-monthly",
        method: "GET",
        headers: {
          token: localStorage.getItem("token")
        }
      })
      .done((dataJadwalSholat) => {
        console.log("JADWAL SHOLAT");
        $("#title-jadwal-sholat").empty().append(`
          Jadwal Sholat Bulan Ini
        `)
        $("#row-jadwal-sholat").show()
        $("#tbody-jadwal-sholat").empty()
        dataJadwalSholat.results.datetime.forEach((data, index) => {
          $("#tbody-jadwal-sholat").append(`
            <tr>
              <td>${index+1}</td>
              <td>${dataJadwalSholat.results.location.city}</td>
              <td>${data.times.Fajr}</td>
              <td>${data.times.Dhuhr}</td>
              <td>${data.times.Asr}</td>
              <td>${data.times.Maghrib}</td>
              <td>${data.times.Isha}</td>
            </tr>
          `);

        })
      })
      .fail((xhr, text) => {
        console.log(xhr,text);
        swalFail(xhr.responseJSON.error)
      })
      
    }
    
    function getWeather() { 
      $.ajax({
        url: base_url + "weather",
        method: "GET",
        headers: {
          token: localStorage.getItem("token")
        }
      })
      .done((dataWeather) => {
        $("#row-weather").show()
        $("#row-weather").empty()
        $("#row-weather").append(`
          <div class="card mt-5 pl-0 pr-0 col-md-3 mx-auto">
            <div class="card p-4">
                <div class="d-flex">
                    <h6 class="flex-grow-1">${dataWeather.data[0].city_name}</h6>
                </div>
                <div class="d-flex flex-column temp mt-5 mb-3">
                    <h1 class="mb-0 font-weight-bold" id="heading"> ${dataWeather.data[0].temp}Â° C </h1> <span class="small grey">${dataWeather.data[0].weather.description}</span>
                </div>
                <div class="d-flex">
                    <div class="temp-details flex-grow-1">
                        <p class=""> <i class="fas fa-wind mr-2" aria-hidden="true"></i> <span> ${dataWeather.data[0].wind_spd} m/s </span> </p>
                        <p class=""> <i class="fa fa-tint mr-2" aria-hidden="true"></i> <span> ${dataWeather.data[0].rh}% </span> </p>
                    </div>
                    <div> <img src="https://www.weatherbit.io/static/img/icons/${dataWeather.data[0].weather.icon}.png"> </div>
                    
                </div>
            </div>
          </div>
        `);
        // $("#tbody-jadwal-sholat").empty()
        
      })
      .fail((xhr, text) => {
        console.log(xhr,text);
        swalFail(xhr.responseJSON.error)
      })
      
    }
    
    function getAlQuran() {
      $.ajax({
        url: base_url + "alquran",
        method: "GET",
        headers: {
          token: localStorage.getItem("token")
        }
      })
      .done((alquran) => {
        $("#tbody-alquran").empty();
        alquran.forEach((el, number) => {
          console.log('YEY');
          $("#tbody-alquran").append(`
            <tr>
              <td>${number + 1}</td>
              <td>${el.nama}</td>
              <td>${el.asma}</td>
              <td>${el.ayat}</td>
              <td>${el.arti}</td>
              <td>${el.urut}</td>
              <td>
                <audio controls>
                  <source src="${el.audio}" type="audio/mp3">
                    Your browser does not support the audio element.
                  </audio>  
              </td>
            </tr>
          `)
        });
      })
      .fail((xhr, text) => {
        console.log(xhr,text);
        swalFail(xhr.responseJSON.error)
      })
    }

    function getKisahNabi() {
      const nabi = $("#input-nabi").val();
      console.log(nabi);
      $.ajax({
        url: base_url + "kisah-nabi",
        method: "POST",
        headers: {
          token: localStorage.getItem("token")
        },
        data: {
          nabi
        }
      })
      .done((kisahNabi) => {
        // $("#tbody-kisah-nabi").append(`
        //     <tr>
        //       <td>1</td>
        //       <td>${kisahNabi.nabi.nama}</td>
        //       <td>${kisahNabi.nabi.lahir}</td>
        //       <td>${kisahNabi.nabi.umur}</td>
        //       <td>${kisahNabi.nabi.tempat}</td>
        //       <td><img src="${kisahNabi.nabi.image}"></td>
        //       <td>${kisahNabi.nabi.kisah}</td>
        //     </tr>
        //   `)
        $("#body-kisah-nabi").empty();
        $('#body-kisah-nabi').append(`
          <h1>${kisahNabi.nabi.nama}</h1>
          <img src="${kisahNabi.nabi.image}">
          <h5>Umur : ${kisahNabi.nabi.umur}</h5>
          <h5>${kisahNabi.nabi.tempat}</h5>
          <p>${kisahNabi.nabi.kisah}</p>
        `)
      })
      .fail((xhr, text) => {
        console.log(xhr,text);
        swalFail(xhr.responseJSON.error)
      })
      .always(() => {
        $("#form-nabi").trigger("reset");
      })
    }
    
    function anchorRegister() {
      $("#row-login").hide()
      $("#row-register").show()
    }
  
    function anchorLogin(){
      auth()
    }

    function swalFail(err) {
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: err,
      })
    }
    </script>

    
    
  </body>
  </html>